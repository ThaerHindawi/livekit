# Production Docker Compose - All-in-One Setup
# Usage: docker-compose -f docker-compose.prod.yml up -d

services:
  # ===========================================
  # LiveKit Server (WebRTC SFU)
  # ===========================================
  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit-server
    ports:
      - "7880:7880"     # WebSocket signaling
      - "7881:7881"     # RTC over TCP
      - "7882:7882/udp" # RTC over UDP (primary for video/audio)
    command: >
      --dev
      --bind 0.0.0.0
      --keys "devkey: secret"
    restart: unless-stopped
    networks:
      - livekit-network

  # ===========================================
  # Node.js Token Server + Web App
  # ===========================================
  webapp:
    build: .
    container_name: livekit-webapp
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - LIVEKIT_API_KEY=devkey
      - LIVEKIT_API_SECRET=secret
      - LIVEKIT_WS_URL=ws://localhost:7880
    depends_on:
      - livekit
    restart: unless-stopped
    networks:
      - livekit-network

  # ===========================================
  # Caddy (Automatic HTTPS Reverse Proxy)
  # Uncomment this section when deploying to VPS with a domain
  # ===========================================
  # caddy:
  #   image: caddy:latest
  #   container_name: livekit-caddy
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./Caddyfile:/etc/caddy/Caddyfile
  #     - caddy_data:/data
  #     - caddy_config:/config
  #   depends_on:
  #     - webapp
  #     - livekit
  #   restart: unless-stopped
  #   networks:
  #     - livekit-network

networks:
  livekit-network:
    driver: bridge

# volumes:
#   caddy_data:
#   caddy_config:

